---
title: "Projet RATP"
output: html_notebook
---

Ajout des librairies 
```{r}

library("dplyr")
library("readr")
library("ggplot2")
library("ggplot2")
library("ggthemes")
library("leaflet")
library("forcats")

```

Où sommes nous ? 

```{r}
getwd()
```



```{r}

routes <- read_csv("RATP_GTFS_FULL/routes.txt", col_names = TRUE)

```
```{r}
View(routes)
```

```{r}

stops <- read_csv("RATP_GTFS_FULL/stops.txt", col_names = TRUE)

```

```{r}
View(stops)
```

```{r}
transfers <- read_csv("RATP_GTFS_FULL/transfers.txt", col_names = TRUE)


```

```{r}
View(transfers)
```


```{r}
trips <- read_csv("RATP_GTFS_FULL/trips.txt", col_names = TRUE)
```
```{r}
View(trips)
```


Test de carte (inutile)
```{r}
test_carte <- ggplot(data = stops) +
  geom_path(aes(stop_lon, stop_lat),
            size = 0.5, alpha = .1) +
  coord_equal() +
  theme_map()

```

```{r}
test_carte
```

Autre carte avec les points 
```{r}
test_carte2 <- ggplot(data = stops) +
  geom_point(aes(stop_lon, stop_lat, group = stop_id),
            size = 0.5, alpha = .1) +
  coord_equal() +
  theme_map()
```

```{r}
test_carte2
```


```{r}
devtools::install_github('ropensci/gtfsr')
```

```{r}
stop_times <- read_csv("RATP_GTFS_FULL/stop_times.txt", col_names = TRUE)
```
map avec tous les stops -même bus 
```{r}
map <- leaflet() %>%
  # Add CartoDB background map
  addProviderTiles("CartoDB.DarkMatter") %>%  
  # Add a marker for each stop
  addCircleMarkers(lng= ~ stop_lon, lat= ~stop_lat, data = stops,
                   stroke = FALSE, fillOpacity = 0.5, radius =5 ) 
map  # Show the map
```


```{r}

View(stop_times)
```
```{r}
rm(full_base_bas)
```

Premier joint 
```{r}

full_base_bas <- stops %>%
  full_join(stop_times, by= "stop_id") %>%
  full_join(trips, by = "trip_id")

```

```{r}

full_base <- stops %>%
  full_join(stop_times, by= "stop_id") %>%
  full_join(trips, by = "trip_id")%>%
  full_join(routes, by = "route_id")


```


base avec uniquement les lignes correspondant au métro et au RER 
```{r}

full_base_metro <- full_base %>%
  filter (route_type == 1 | route_type== 2 )

```

```{r}
View(full_base_metro)
```

```{r}
full_base_metro$stop_code <- NULL

```

```{r}
full_base_metro$location_type <- NULL
full_base_metro$parent_station <- NULL 
full_base_metro$ shape_dist_traveled <- NULL 
full_base_metro$stop_headsign <- NULL 
```

```{r}
full_base_metro$ shape_id <- NULL 
full_base_metro$agency_id <- NULL 
full_base_metro$route_desc <- NULL 
full_base_metro$route_url<-NULL
full_base_metro$route_color<-NULL 
full_base_metro$route_text_color <-NULL 
```
Base avec toutes les informations nécéssaires sans les colonnes inutiles 
```{r}
base_metro <- full_base_metro
```


```{r}
View(base_metro %>% 
       filter(route_short_name == "7B", stop_name =="Place des Fêtes"))
```

```{r}
View(base_metro)
library(magrittr) 
library(dplyr)
```
Crée une nouvelle base pour la visualisation : garde un unique stop par ligne de métro (ainsi il n'y a qu'un seul arret pour la 1 à Pont de Neuilly, mais il y a plusieurs points à Charles de Gaulle étoile pour chacune des lignes qui passe à CdGE )
```{r}
base_metro_map <- base_metro %>%
  distinct(stop_name, route_short_name, .keep_all = TRUE)
```

```{r}
View(base_metro_map)
```

Map avec uniquement les stations de métro et de bus (mais sans différencier les lignes)
```{r}
map_metro <- leaflet() %>%
  # Add CartoDB background map
  addProviderTiles("CartoDB.DarkMatter") %>%  
  # Add a marker for each stop
  addCircleMarkers(lng= ~ stop_lon, lat= ~stop_lat, data = base_metro_map,
                   stroke = FALSE, fillOpacity = 0.5, radius =5 ) 
map_metro  # Show the map
```

Met un factor sur route_short_name
```{r}
base_metro_map$route_short_name = factor(base_metro_map$route_short_name)
library(forcats)
base_metro_map$route_short_name
```
Ordonne le factor
```{r}
base_metro_map$route_short_name <- fct_relevel(base_metro_map$route_short_name, c(1, 2, 3, "3B", 4, 5, 6, 7, "7B", 8, 9, 10, 11, 12, 13, 14, "A", "B"))
```
Donne les bonnes couleurs à chaque ligne (couleur officielle des lignes)
```{r}
factpal=colorFactor(palette = c("#FFCD00", "#003CA6", "#837902", "#00AE41", "#CF009E", "#FF7E2E", "#6ECA97", "#FA9ABA", "#6ECA97", "#E19BDF", "#B6BD00", "#C9910D", "#704B1C", "#007852", "#6EC4E8", "#62259D", "#E2231A", "#7BA3DC"), 
            domain = base_metro_map$route_short_name, levels = levels(base_metro_map$route_short_name), ordered = TRUE, na.color = "#808080", alpha = FALSE)
```
Création de la map avec les points de bonne couleur par station de métro (+ légende ordonnée)
```{r}
map_metro_color = leaflet() %>%
  # Add CartoDB background map
  addProviderTiles("CartoDB.DarkMatter") %>%  
  # Add a marker for each stop
  addCircleMarkers(lng= ~ stop_lon, lat= ~stop_lat, data = base_metro_map, stroke = FALSE, 
                   fillOpacity = 0.5, radius =4, color = ~ factpal(route_short_name)) %>% 
  addLegend(colors =c("#FFCD00", "#003CA6", "#837902", "#00AE41", "#CF009E", "#FF7E2E", "#6ECA97", "#FA9ABA", "#6ECA97", "#E19BDF", "#B6BD00", "#C9910D", "#704B1C", "#007852", "#6EC4E8", "#62259D", "#E2231A", "#7BA3DC"),
            labels = levels(base_metro_map$route_short_name),title = "Metro line Paris")
map_metro_color  # Show the map


##, label = ~as.character(stop_name), labelOptions = labelOptions(noHide = TRUE, direction = 'top', textOnly = TRUE, style = list("color"= "white", "front_size" = "1px"))
##, style= list("color"= ~ factpal(route_short_name), 'box-shadow' = '3px 3px rgba(0,0,0,0.25)','font-size' = '12px', 'border-color' = 'rgba(0,0,0,0.5)'))
```
Faisons la même visualisation avec ggplot 

```{r}
map_metro_color_ggplot <- ggplot (data= base_metro_map, aes(stop_lon, stop_lat, color= route_short_name)) + 
  geom_point(size = 1, alpha = 1) +
  coord_equal() +
  scale_color_manual(values= c("#FFCD00", "#003CA6", "#837902", "#00AE41", "#CF009E", "#FF7E2E", "#6ECA97", "#FA9ABA", "#6ECA97", "#E19BDF", "#B6BD00", "#C9910D", "#704B1C", "#007852", "#6EC4E8", "#62259D", "#E2231A", "#7BA3DC"))
  theme_map()
```
```{r}
map_metro_color_ggplot

```


```{r}
View(base_metro)
```

Nous avons arrangé chaque station de métro dans la bonne séquence en fonction de sa ligne. Mais problème avec les RER A et B (avec les sections )
```{r}

base_trajet_seq <- base_metro %>%
        distinct(stop_name, route_id, .keep_all = TRUE)%>%
        #filter(direction_id == 0) %>%
      arrange(route_id, trip_headsign, direction_id, stop_sequence)
```




Arrangement pour le RER B : on ne garde que les lignes KOCQ et SOIR . Fais les trajets KOCQ : Aeroport ==> Massy Pal, SOIR ==> Mitry Claye ==> Robinson. Nous avons toutes les stations jusqu'à massy palaiseau, ordonnées. mais en double sur la branche principale 
```{r}

base_trajet_rerb <- base_trajet_seq %>% 
        filter (route_short_name =="B", trip_headsign =="KOCQ" | trip_headsign =="SOIR")

```

IDEM  pour le RER A : NELY ==> Saint Germain Boissy Saint Léger, Cergy le Haut ==> Marne la Vallée 
```{r}
base_trajet_rera <-base_trajet_seq %>% 
       filter (route_short_name=="A", trip_headsign== "NELY" | trip_headsign =="QIKY")
```
Nous avons de nouveau un problème avec la 7 : faut supprimer 4 stations de métro de métro  

```{r}
base_trajet_7 <- base_trajet_seq %>% 
  filter (route_short_name == 7, stop_id != 2505, stop_id != 2506, stop_id != 2519, stop_id != 2250)
```


Problème avec la 7B 

```{r}
trajet7B_0 <-base_trajet_seq %>% filter(route_short_name == '7B', direction_id == 0, stop_id != 1797 )
trajet7B_1 <-base_trajet_seq %>% filter(route_short_name == '7B', direction_id == 1, stop_id != 1635 )

trajet7B_1_2 <- trajet7B_1 %>% filter (stop_id== 1797) %>% mutate(stop_sequence =2)
trajet7B_1_3 <- trajet7B_1 %>% filter (stop_id!= 1797)

trajet7B_1 <- rbind(trajet7B_1_2, trajet7B_1_3)


base_trajet_7B_total <- rbind(trajet7B_0, trajet7B_1)

base_trajet_7B <-  base_trajet_7B_total %>% arrange ( direction_id, stop_sequence)
```



Nous avons le même problème sur la 13 que sur la 7: 

```{r}
base_trajet_13 <- base_trajet_total %>% filter (route_short_name ==13) %>% filter ((service_id != 2280400 | trip_headsign != 201) & (service_id != 2280400 | trip_headsign != 202) & (service_id != 2280405 | trip_headsign != 102))
```
Nous avons un problème avec la 10 (boucle: il faut supprimer trip_short_name ==104)

```{r}
base_trajet_10 <- base_trajet_seq %>% 
  filter (route_short_name ==10, trip_short_name != 104)
```


```{r}
base_trajet_metro <- base_trajet_seq%>%
  filter(route_type == 1, route_short_name != 7, route_short_name != 10,  route_short_name != 13, route_short_name != "7B")
```


Maintenant on va rbind les 3 bases pour la base finale 

```{r}
base_trajet_total <- rbind.data.frame(base_trajet_metro, base_trajet_rera, base_trajet_rerb, base_trajet_7, base_trajet_10, base_trajet_13, base_trajet_7B)
```

Tout comme précédemment faisons de route_short_name un factor 
```{r}
library(forcats)
base_trajet_total$route_short_name <- fct_relevel(base_trajet_total$route_short_name, c(1, 2, 3, "3B", 4, 5, 6, 7, "7B", 8, 9, 10, 11, 12, 13, 14, "A", "B"))
```

```{r}
View(base_trajet_total)
```

Essai visualisation avec ggplot des lignes de métro reliées entre elles 

Essai visualisation par ligne 

```{r}
ggplot (data= base_trajet_total %>% filter (route_short_name == 2), 
        aes(stop_lon, stop_lat, group= route_id, color= route_short_name)) + 
  geom_point(size = 1, alpha = 1) +
  geom_path()+
  scale_color_manual(values= c("#FFCD00"))
  theme_map()
```

Essai total: 
```{r}
ggplot (data= base_trajet_total, aes(stop_lon, stop_lat, group= route_id, color= route_short_name)) + 
  geom_point(size = 1, alpha = 1) +
  geom_path()+
  scale_color_manual(values= c("#FFCD00", "#003CA6", "#837902", "#00AE41", "#CF009E", "#FF7E2E", "#6ECA97", "#FA9ABA", "#6ECA97", "#E19BDF", "#B6BD00", "#C9910D", "#704B1C", "#007852", "#6EC4E8", "#62259D", "#E2231A", "#7BA3DC"))
  theme_map()

```



 '''
  addPolylines(lng= ~ stop_lon, lat= ~stop_lat, data = base_trajet_total %>% filter(route_short_name== 1, direction_id ==0), group = ~ route_id, weight = 2,  fillOpacity = 0.5, color = "#FFCD00")%>%
  addPolylines(lng= ~ stop_lon, lat= ~stop_lat, data = base_trajet_total %>% filter(route_short_name== 2, direction_id ==0), group = ~ route_id, weight = 2,  fillOpacity = 0.5, color = "#003CA6")%>%
  addPolylines(lng= ~ stop_lon, lat= ~stop_lat, data = base_trajet_total %>% filter(route_short_name== 3, direction_id ==0), group = ~ route_id, weight = 2,  fillOpacity = 0.5, color = "#837902")%>%
  addPolylines(lng= ~ stop_lon, lat= ~stop_lat, data = base_trajet_total %>% filter(route_short_name== "3B", direction_id ==0), group = ~ route_id, weight = 2,  fillOpacity = 0.5, color = "#00AE41")%>%
  addPolylines(lng= ~ stop_lon, lat= ~stop_lat, data = base_trajet_total %>% filter(route_short_name== 4, direction_id ==0), group = ~ route_id, weight = 2,  fillOpacity = 0.5, color = "#CF009E")%>%
  addPolylines(lng= ~ stop_lon, lat= ~stop_lat, data = base_trajet_total %>% filter(route_short_name== 5, direction_id ==0), group = ~ route_id, weight = 2,  fillOpacity = 0.5, color = "#FF7E2E")%>%
  addPolylines(lng= ~ stop_lon, lat= ~stop_lat, data = base_trajet_total %>% filter(route_short_name== 6, direction_id ==0), group = ~ route_id, weight = 2,  fillOpacity = 0.5, color = "#6ECA97")%>%
    addPolylines(lng= ~ stop_lon, lat= ~stop_lat, data = base_trajet_total %>% filter(route_short_name== 7, trip_short_name ==101), group = ~ route_id, weight = 2,  fillOpacity = 0.5, color = "#FA9ABA")%>%
    addPolylines(lng= ~ stop_lon, lat= ~stop_lat, data = base_trajet_total %>% filter(route_short_name== 7, trip_short_name ==201), group = ~ route_id, weight = 2,  fillOpacity = 0.5, color = "#FA9ABA")%>%
      addPolylines(lng= ~ stop_lon, lat= ~stop_lat, data = base_trajet_total %>% filter(route_short_name== "7B", trip_short_name ==101), group = ~ route_id, weight = 2,  fillOpacity = 0.5, color = "#6ECA97")%>%
  addPolylines(lng= ~ stop_lon, lat= ~stop_lat, data = base_trajet_total %>% filter(route_short_name== "7B", trip_short_name ==201), group = ~ route_id, weight = 2,  fillOpacity = 0.5, color = "#6ECA97")%>%
  addPolylines(lng= ~ stop_lon, lat= ~stop_lat, data = base_trajet_total %>% filter(route_short_name== 8, direction_id ==0), group = ~ route_id, weight = 2,  fillOpacity = 0.5, color = "#E19BDF")%>%
  addPolylines(lng= ~ stop_lon, lat= ~stop_lat, data = base_trajet_total %>% filter(route_short_name== 9, direction_id ==0), group = ~ route_id, weight = 2,  fillOpacity = 0.5, color = "#B6BD00")%>%
    addPolylines(lng= ~ stop_lon, lat= ~stop_lat, data = base_trajet_total %>% filter(route_short_name== 10), group = ~ route_id, weight = 2,  fillOpacity = 0.5, color = "#C9910D")%>%
  addPolylines(lng= ~ stop_lon, lat= ~stop_lat, data = base_trajet_total %>% filter(route_short_name== 11, direction_id ==0), group = ~ route_id, weight = 2,  fillOpacity = 0.5, color = "#704B1C")%>%
  addPolylines(lng= ~ stop_lon, lat= ~stop_lat, data = base_trajet_total %>% filter(route_short_name== 12, direction_id ==0), group = ~ route_id, weight = 2,  fillOpacity = 0.5, color = "#007852")%>%
    addPolylines(lng= ~ stop_lon, lat= ~stop_lat, data = base_trajet_total %>% filter(route_short_name== 13, trip_short_name ==101), group = ~ route_id, weight = 2,  fillOpacity = 0.5, color = "#6EC4E8")%>%
    addPolylines(lng= ~ stop_lon, lat= ~stop_lat, data = base_trajet_total %>% filter(route_short_name== 13, trip_short_name ==102), group = ~ route_id, weight = 2,  fillOpacity = 0.5, color = "#6EC4E8")%>%
  addPolylines(lng= ~ stop_lon, lat= ~stop_lat, data = base_trajet_total %>% filter(route_short_name== 14, direction_id ==0), group = ~ route_id, weight = 2,  fillOpacity = 0.5, color = "#62259D")%>%
    addPolylines(lng= ~ stop_lon, lat= ~stop_lat, data = base_trajet_total %>% filter(route_short_name== "A", trip_headsign == "NELY"), group = ~ route_id, weight = 2,  fillOpacity = 0.5, color = "#E2231A")%>%
    addPolylines(lng= ~ stop_lon, lat= ~stop_lat, data = base_trajet_total %>% filter(route_short_name== "A", trip_headsign == "QIKY"), group = ~ route_id, weight = 2,  fillOpacity = 0.5, color = "#E2231A")%>%
      addPolylines(lng= ~ stop_lon, lat= ~stop_lat, data = base_trajet_total %>% filter(route_short_name== "B", trip_headsign == "SOIR"), group = ~ route_id, weight = 2,  fillOpacity = 0.5, color = "#7BA3DC")%>%
    addPolylines(lng= ~ stop_lon, lat= ~stop_lat, data = base_trajet_total %>% filter(route_short_name== "B", trip_headsign == "KOCQ"), group = ~ route_id, weight = 2,  fillOpacity = 0.5, color = "#7BA3DC")%>%
  ''' 
```{r}
View(base_trajet_rerb)
```


```{r}

map_metro_ligne = leaflet() %>%
  # Add CartoDB background map
  addProviderTiles("CartoDB.DarkMatter") %>%  
  # Add a marker for each stop
  addPolylines(lng= ~ stop_lon, lat= ~stop_lat, data = base_trajet_total %>% filter(route_short_name== 1, direction_id ==0), group = ~ route_id, weight = 2,  fillOpacity = 0.5, color = "#FFCD00")%>%
  addPolylines(lng= ~ stop_lon, lat= ~stop_lat, data = base_trajet_total %>% filter(route_short_name== 2, direction_id ==0), group = ~ route_id, weight = 2,  fillOpacity = 0.5, color = "#003CA6")%>%
  addPolylines(lng= ~ stop_lon, lat= ~stop_lat, data = base_trajet_total %>% filter(route_short_name== 3, direction_id ==0), group = ~ route_id, weight = 2,  fillOpacity = 0.5, color = "#837902")%>%
  addPolylines(lng= ~ stop_lon, lat= ~stop_lat, data = base_trajet_total %>% filter(route_short_name== "3B", direction_id ==0), group = ~ route_id, weight = 2,  fillOpacity = 0.5, color = "#00AE41")%>%
  addPolylines(lng= ~ stop_lon, lat= ~stop_lat, data = base_trajet_total %>% filter(route_short_name== 4, direction_id ==0), group = ~ route_id, weight = 2,  fillOpacity = 0.5, color = "#CF009E")%>%
  addPolylines(lng= ~ stop_lon, lat= ~stop_lat, data = base_trajet_total %>% filter(route_short_name== 5, direction_id ==0), group = ~ route_id, weight = 2,  fillOpacity = 0.5, color = "#FF7E2E")%>%
  addPolylines(lng= ~ stop_lon, lat= ~stop_lat, data = base_trajet_total %>% filter(route_short_name== 6, direction_id ==0), group = ~ route_id, weight = 2,  fillOpacity = 0.5, color = "#6ECA97")%>%
    addPolylines(lng= ~ stop_lon, lat= ~stop_lat, data = base_trajet_total %>% filter(route_short_name== 7, trip_short_name ==101), group = ~ route_id, weight = 2,  fillOpacity = 0.5, color = "#FA9ABA")%>%
    addPolylines(lng= ~ stop_lon, lat= ~stop_lat, data = base_trajet_total %>% filter(route_short_name== 7, trip_short_name ==201), group = ~ route_id, weight = 2,  fillOpacity = 0.5, color = "#FA9ABA")%>%
      addPolylines(lng= ~ stop_lon, lat= ~stop_lat, data = base_trajet_total %>% filter(route_short_name== "7B", trip_short_name ==101), group = ~ route_id, weight = 2,  fillOpacity = 0.5, color = "#6ECA97")%>%
  addPolylines(lng= ~ stop_lon, lat= ~stop_lat, data = base_trajet_total %>% filter(route_short_name== "7B", trip_short_name ==201), group = ~ route_id, weight = 2,  fillOpacity = 0.5, color = "#6ECA97")%>%
  addPolylines(lng= ~ stop_lon, lat= ~stop_lat, data = base_trajet_total %>% filter(route_short_name== 8, direction_id ==0), group = ~ route_id, weight = 2,  fillOpacity = 0.5, color = "#E19BDF")%>%
  addPolylines(lng= ~ stop_lon, lat= ~stop_lat, data = base_trajet_total %>% filter(route_short_name== 9, direction_id ==0), group = ~ route_id, weight = 2,  fillOpacity = 0.5, color = "#B6BD00")%>%
    addPolylines(lng= ~ stop_lon, lat= ~stop_lat, data = base_trajet_total %>% filter(route_short_name== 10), group = ~ route_id, weight = 2,  fillOpacity = 0.5, color = "#C9910D")%>%
  addPolylines(lng= ~ stop_lon, lat= ~stop_lat, data = base_trajet_total %>% filter(route_short_name== 11, direction_id ==0), group = ~ route_id, weight = 2,  fillOpacity = 0.5, color = "#704B1C")%>%
  addPolylines(lng= ~ stop_lon, lat= ~stop_lat, data = base_trajet_total %>% filter(route_short_name== 12, direction_id ==0), group = ~ route_id, weight = 2,  fillOpacity = 0.5, color = "#007852")%>%
    addPolylines(lng= ~ stop_lon, lat= ~stop_lat, data = base_trajet_total %>% filter(route_short_name== 13, trip_short_name ==101), group = ~ route_id, weight = 2,  fillOpacity = 0.5, color = "#6EC4E8")%>%
    addPolylines(lng= ~ stop_lon, lat= ~stop_lat, data = base_trajet_total %>% filter(route_short_name== 13, trip_short_name ==102), group = ~ route_id, weight = 2,  fillOpacity = 0.5, color = "#6EC4E8")%>%
  addPolylines(lng= ~ stop_lon, lat= ~stop_lat, data = base_trajet_total %>% filter(route_short_name== 14, direction_id ==0), group = ~ route_id, weight = 2,  fillOpacity = 0.5, color = "#62259D")%>%
    addPolylines(lng= ~ stop_lon, lat= ~stop_lat, data = base_trajet_total %>% filter(route_short_name== "A", trip_headsign == "NELY"), group = ~ route_id, weight = 2,  fillOpacity = 0.5, color = "#E2231A")%>%
    addPolylines(lng= ~ stop_lon, lat= ~stop_lat, data = base_trajet_total %>% filter(route_short_name== "A", trip_headsign == "QIKY"), group = ~ route_id, weight = 2,  fillOpacity = 0.5, color = "#E2231A")%>%
      addPolylines(lng= ~ stop_lon, lat= ~stop_lat, data = base_trajet_total %>% filter(route_short_name== "B", trip_headsign == "SOIR"), group = ~ route_id, weight = 2,  fillOpacity = 0.5, color = "#7BA3DC")%>%
    addPolylines(lng= ~ stop_lon, lat= ~stop_lat, data = base_trajet_total %>% filter(route_short_name== "B", trip_headsign == "KOCQ"), group = ~ route_id, weight = 2,  fillOpacity = 0.5, color = "#7BA3DC")%>%

  addCircleMarkers(lng= ~ stop_lon, lat= ~stop_lat, data = base_trajet_total, stroke = FALSE, 
                  fillOpacity = 0.5, radius =4, color = ~ factpal(route_short_name)) %>% 
  addLegend(colors =c("#FFCD00", "#003CA6", "#837902", "#00AE41", "#CF009E", "#FF7E2E", "#6ECA97", "#FA9ABA", "#6ECA97", "#E19BDF", "#B6BD00", "#C9910D", "#704B1C", "#007852", "#6EC4E8", "#62259D", "#E2231A", "#7BA3DC"),
            labels = levels(base_trajet_total$route_short_name),title = "Metro line Paris")
map_metro_ligne  # Show the map



```
